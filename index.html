<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynka — لوحة الإدارة</title>
  <style>
    :root{
      --bg:#F6F8FC;            /* خلفية هادئة */
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --card:#ffffff;
      --shadow:0 12px 40px rgba(2,6,23,.06);

      /* ألوان أكسنت للتبويبات */
      --tab1:#6366F1; /* tasks */
      --tab2:#10B981; /* prices */
      --tab3:#7C3AED; /* orders */
      --tab4:#0EA5E9; /* finance */

      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial}
    .wrap{max-width:1040px;margin:0 auto;padding:0 16px}

    /* ——— Topbar ——— */
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#fff,rgba(255,255,255,.8));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .topbar .row{display:flex;align-items:center;gap:12px;padding:12px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#5b6cff,#19c6d1);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
    .brand h1{margin:0;font-size:20px}

    /* ——— Chrome-like Tabs ——— */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;padding:10px 0 14px}
    .tab{
      position:relative;
      padding:12px 18px;
      border:1px solid var(--line);
      border-bottom:none;
      background:#fff;
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      font-weight:800; cursor:pointer;
      box-shadow:0 6px 20px rgba(2,6,23,.06);
      transform:translateY(6px); /* غير مفعّل يظهر منخفض شوية */
      opacity:.9;
    }
    .tab[data-s="tasks"]{--accent:var(--tab1)}
    .tab[data-s="prices"]{--accent:var(--tab2)}
    .tab[data-s="orders"]{--accent:var(--tab3)}
    .tab[data-s="finance"]{--accent:var(--tab4)}

    .tab:hover{opacity:1}
    .tab.active{
      background:linear-gradient(180deg,#fff, #f8fbff);
      border-color:color-mix(in oklab, var(--accent) 45%, var(--line));
      transform:translateY(0); /* المفعّل يطلع لفوق */
      opacity:1;
      outline:3px solid color-mix(in oklab, var(--accent) 16%, transparent);
    }

    /* ——— Cards / Sections ——— */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:0 0 18px;
    }
    .row-flex{display:flex;gap:10px;flex-wrap:wrap}
    .row-flex>*{flex:1 1 160px}
    input,select,textarea,button{
      border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;font-size:14px;outline:none
    }
    textarea{min-height:72px;resize:vertical}
    button{cursor:pointer;font-weight:800}
    .btn{color:#fff;border:none;background:linear-gradient(135deg, var(--accent), color-mix(in oklab,var(--accent) 60%, #8be9ff))}
    .btn-ghost{background:#f3f4f6}
    .danger{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff;border:none}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{display:flex;gap:10px;align-items:flex-start;background:#fff;border:1px solid var(--line);padding:12px;border-radius:12px}
    .item-title{font-weight:800}
    .item-sub{color:var(--muted);font-size:12px}

    /* Prices tweaks */
    .price-big{font-size:20px;font-weight:900;letter-spacing:.2px}

    /* Finance two columns */
    .two-col{display:grid;gap:14px}
    @media(min-width:800px){ .two-col{grid-template-columns:1fr 1fr} }
    .total{display:flex;justify-content:space-between;gap:10px;margin-top:8px;font-weight:900}
    .net{display:flex;justify-content:center;gap:16px;align-items:center;margin-top:12px;padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fafcff}

    /* KPI small bar */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
    .kpi .n{font-weight:900;font-size:20px}

    /* Helpers */
    .hide{display:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><div class="logo">L</div><h1>Lynka — لوحة الإدارة</h1></div>
      <div style="margin-inline-start:auto;display:flex;align-items:center;gap:8px">
        <span id="userEmail" class="muted" style="display:none;font-size:12px"></span>
        <button id="logoutBtn" class="tab" style="padding:8px 14px;transform:none;border-bottom:1px solid var(--line)">تسجيل الخروج</button>
      </div>
    </div>
    <div class="wrap tabs" id="tabs">
      <div class="tab active" data-s="tasks">المهام</div>
      <div class="tab" data-s="prices">الأسعار</div>
      <div class="tab" data-s="orders">الأوردرات</div>
      <div class="tab" data-s="finance">مصروفات وأرباح</div>
    </div>
  </div>

  <!-- Auth card -->
  <div class="wrap" id="authCard" style="margin-top:16px">
    <div class="card" style="text-align:center">
      <h2 style="margin:6px 0 12px">تسجيل دخول Lynka</h2>
      <div class="row-flex">
        <input id="email" placeholder="1@lynka.com أو 2@lynka.com" />
        <input id="password" type="password" placeholder="••••••••" />
        <button class="btn" id="loginBtn" style="--accent:#5b6cff">دخول</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px;color:#b91c1c"></div>
    </div>
  </div>

  <div class="wrap hide" id="app" style="margin-top:16px">
    <div class="kpis">
      <div class="kpi"><div class="muted" style="font-size:12px">مهام نشطة</div><div class="n" id="kpiTasks">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">طلبات</div><div class="n" id="kpiOrders">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">إجمالي أرباح</div><div class="n" id="kpiRev">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">إجمالي مصروفات</div><div class="n" id="kpiExp">0</div></div>
    </div>

    <!-- TASKS -->
    <section id="s-tasks" class="card" style="--accent:var(--tab1)">
      <h3 style="margin-top:0">قائمة المهام</h3>
      <div class="row-flex">
        <textarea id="taskText" placeholder="اكتب مهمة (يسمح بنص طويل)…"></textarea>
        <select id="taskTag">
          <option value="">— وسم —</option><option>مهم</option><option>عميل</option><option>توصيل</option>
        </select>
        <input type="date" id="taskDue">
        <button class="btn" id="addTask">إضافة</button>
        <button class="btn-ghost" id="clearSelectedTasks">حذف المحدد</button>
      </div>

      <div class="row-flex" style="margin-top:10px">
        <input id="taskSearch" placeholder="بحث…" />
        <select id="taskFilter">
          <option value="all">الكل</option>
          <option value="today">اليوم</option>
          <option value="overdue">متأخرة</option>
          <option value="tag">حسب الوسم</option>
        </select>
      </div>

      <h4 style="margin:16px 0 6px">المهام النشطة</h4>
      <div class="list" id="tasksActive"></div>

      <h4 style="margin:22px 0 6px">المهام المُنجزة</h4>
      <div class="list" id="tasksDone"></div>
    </section>

    <!-- PRICES -->
    <section id="s-prices" class="card hide" style="--accent:var(--tab2)">
      <h3 style="margin-top:0">الأسعار</h3>
      <div class="row-flex">
        <input id="pName" placeholder="اسم المنتج" />
        <input id="pRetail" type="number" step="0.01" placeholder="سعر التجزئة" />
        <input id="pWholesale" type="number" step="0.01" placeholder="سعر الجملة (اختياري)" />
        <select id="pUnit"><option>قطعة</option><option>علبة</option><option>كيلو</option></select>
        <button class="btn" id="addPrice">إضافة</button>
      </div>
      <div class="list" id="pricesList"></div>
    </section>

    <!-- ORDERS -->
    <section id="s-orders" class="card hide" style="--accent:var(--tab3)">
      <h3 style="margin-top:0">الأوردرات</h3>
      <div class="row-flex">
        <input id="oClient" placeholder="اسم العميل" />
        <input id="oTitle" placeholder="وصف مختصر للطلب" />
        <input id="oAmount" type="number" step="0.01" placeholder="الإجمالي" />
        <select id="oStatus"><option>جديد</option><option>قيد التنفيذ</option><option>تم</option><option>ملغي</option></select>
        <button class="btn" id="addOrder">إضافة</button>
      </div>
      <div class="list" id="ordersList"></div>
    </section>

    <!-- FINANCE (Expenses + Revenues in one tab) -->
    <section id="s-finance" class="card hide" style="--accent:var(--tab4)">
      <h3 style="margin-top:0">مصروفات وأرباح</h3>
      <div class="two-col">
        <!-- Expenses -->
        <div>
          <div class="row-flex">
            <input id="exCat" placeholder="فئة المصروف" />
            <input id="exAmount" type="number" step="0.01" placeholder="القيمة" />
            <input id="exNote" placeholder="ملاحظات (اختياري)" />
            <button class="btn" id="addExpense">إضافة</button>
          </div>
          <div class="list" id="expensesList"></div>
          <div class="total"><span>إجمالي المصروفات</span><span id="expTotal">0</span></div>
        </div>

        <!-- Revenues -->
        <div>
          <div class="row-flex">
            <input id="revCat" placeholder="فئة الربح" />
            <input id="revAmount" type="number" step="0.01" placeholder="القيمة" />
            <input id="revNote" placeholder="ملاحظات (اختياري)" />
            <button class="btn" id="addRevenue">إضافة</button>
          </div>
          <div class="list" id="revenuesList"></div>
          <div class="total"><span>إجمالي الأرباح</span><span id="revTotal">0</span></div>
        </div>
      </div>

      <div class="net">
        <div class="muted">صافي الربح:</div>
        <div id="netTotal" style="font-weight:900">0</div>
      </div>
    </section>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    // ✅ نفس إعداداتك الحالية (لا تغيّرها)
    const firebaseConfig = {
      apiKey: "AIzaSyCnM6-7BoICLWAXUeH8qz8A_OCiCGpQtMU",
      authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
      projectId: "lynka-to-do-list-eb2ac",
      storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
      messagingSenderId: "202285237255",
      appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Helpers
    const $ = s => document.querySelector(s);
    const show = el => el.classList.remove('hide');
    const hide = el => el.classList.add('hide');
    const fmt = n => (Number(n||0)).toLocaleString('en-US',{maximumFractionDigits:2}); // أرقام إنجليزي

    // Tabs (Chrome-like)
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('section[id^="s-"]').forEach(s=>hide(s));
      show($('#s-'+t.dataset.s));
    }));

    // Auth
    $('#loginBtn').onclick = async()=>{
      $('#authMsg').textContent='';
      try{
        await auth.signInWithEmailAndPassword($('#email').value.trim(), $('#password').value.trim());
      }catch(e){ $('#authMsg').textContent = 'Firebase: '+(e.message||'خطأ'); }
    };
    auth.onAuthStateChanged(u=>{
      if(u){ hide($('#authCard')); show($('#app')); initApp(); $('#userEmail').textContent = u.email; $('#userEmail').style.display='inline'; $('#logoutBtn').style.display='inline'; }
      else { show($('#authCard')); hide($('#app')); $('#userEmail').style.display='none'; $('#logoutBtn').style.display='none'; }
    });
    $('#logoutBtn').onclick=()=>auth.signOut();

    // Collections
    const col = {
      tasks: db.collection('tasks'),
      products: db.collection('products'),
      orders: db.collection('orders'),
      expenses: db.collection('expenses'),
      revenues: db.collection('revenues'),
    };

    // ================= TASKS =================
    $('#addTask').onclick = async()=>{
      const text = $('#taskText').value.trim(); if(!text) return;
      await col.tasks.add({
        text, done:false, tag:$('#taskTag').value||'', due:$('#taskDue').value||'',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#taskText').value=''; $('#taskTag').value=''; $('#taskDue').value='';
    };
    $('#clearSelectedTasks').onclick = ()=>{
      document.querySelectorAll('.taskSel:checked').forEach(ch=>{
        col.tasks.doc(ch.dataset.id).delete();
      });
    };

    const isOverdue = due=>{
      if(!due) return false;
      const today = new Date().toISOString().slice(0,10);
      return due < today;
    };

    function renderTask(doc, container){
      const d = doc.data();
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `
        <input type="checkbox" class="taskSel" data-id="${doc.id}">
        <div style="flex:1">
          <div class="item-title">${(d.text||'').replace(/\n/g,'<br>')}</div>
          <div class="item-sub">
            ${d.tag?`<span class="item-sub">#${d.tag}</span>`:''}
            ${d.due?` • <span class="item-sub" style="color:${(!d.done && isOverdue(d.due))?'#b91c1c':'inherit'}">${d.due}</span>`:''}
          </div>
        </div>
        <div class="item-sub" style="display:grid;gap:6px">
          <button class="btn-ghost" data-act="toggle">${d.done?'غير مُنجزة':'إنهاء'}</button>
          <button class="danger" data-act="del">حذف</button>
        </div>`;
      row.querySelector('[data-act="toggle"]').onclick=()=>col.tasks.doc(doc.id).update({done:!d.done, updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
      row.querySelector('[data-act="del"]').onclick=()=>col.tasks.doc(doc.id).delete();
      container.appendChild(row);
    }

    function loadTasks(){
      const A=$('#tasksActive'), D=$('#tasksDone');
      const s = $('#taskSearch').value.trim();
      col.tasks.orderBy('createdAt','desc').onSnapshot(ss=>{
        A.innerHTML=''; D.innerHTML=''; let active=0;
        ss.forEach(doc=>{
          const d=doc.data();
          if(s && !String(d.text).includes(s)) return;
          const target = d.done ? D : A;
          renderTask(doc, target);
          if(!d.done) active++;
        });
        $('#kpiTasks').textContent = fmt(active);
      });
    }
    $('#taskSearch').oninput = loadTasks;

    // ================= PRICES =================
    $('#addPrice').onclick = async()=>{
      const name=$('#pName').value.trim(); if(!name) return;
      await col.products.add({
        name, unit:$('#pUnit').value,
        retail: Number($('#pRetail').value||0),
        wholesale: Number($('#pWholesale').value||0),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#pName').value=''; $('#pRetail').value=''; $('#pWholesale').value='';
    };

    function loadPrices(){
      const L=$('#pricesList'); L.innerHTML='';
      col.products.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML='';
        ss.forEach(doc=>{
          const d=doc.data();
          const el=document.createElement('div');
          el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.name} <span class="item-sub">(${d.unit||'وحدة'})</span></div>
              <div class="item-sub">Wholesale: <b>${fmt(d.wholesale)}</b></div>
            </div>
            <div class="price-big">${fmt(d.retail)}</div>
            <button class="danger">حذف</button>`;
          el.querySelector('button').onclick=()=>col.products.doc(doc.id).delete();
          L.appendChild(el);
        });
      });
    }

    // ================= ORDERS =================
    $('#addOrder').onclick = async()=>{
      const client=$('#oClient').value.trim();
      const title=$('#oTitle').value.trim();
      const amount=Number($('#oAmount').value||0);
      await col.orders.add({
        client, title, amount, status:$('#oStatus').value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#oClient').value=''; $('#oTitle').value=''; $('#oAmount').value='';
    };

    function loadOrders(){
      const L=$('#ordersList');
      col.orders.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML=''; let count=0;
        ss.forEach(doc=>{
          const d=doc.data(); count++;
          const el=document.createElement('div');
          el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.title||'طلب'}</div>
              <div class="item-sub">عميل: <b>${d.client||'-'}</b> • حالة: <b>${d.status}</b> • إجمالي: <b>${fmt(d.amount)}</b></div>
            </div>
            <div class="item-sub" style="display:grid;gap:6px">
              <button class="btn-ghost" data-act="done">إنهاء</button>
              <button class="danger" data-act="del">حذف</button>
            </div>`;
          el.querySelector('[data-act="done"]').onclick=()=>col.orders.doc(doc.id).update({status:'تم'});
          el.querySelector('[data-act="del"]').onclick=()=>col.orders.doc(doc.id).delete();
          L.appendChild(el);
        });
        $('#kpiOrders').textContent = fmt(count);
      });
    }

    // ================= FINANCE (one tab) =================
    $('#addExpense').onclick = async()=>{
      const cat=$('#exCat').value.trim(); const amount=Number($('#exAmount').value||0);
      await col.expenses.add({
        category:cat, amount, note:$('#exNote').value.trim(),
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#exCat').value=''; $('#exAmount').value=''; $('#exNote').value='';
    };
    $('#addRevenue').onclick = async()=>{
      const cat=$('#revCat').value.trim(); const amount=Number($('#revAmount').value||0);
      await col.revenues.add({
        category:cat, amount, note:$('#revNote').value.trim(),
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#revCat').value=''; $('#revAmount').value=''; $('#revNote').value='';
    };

    function financeRow(d, del){
      const el=document.createElement('div');
      el.className='item';
      el.innerHTML=`
        <div style="flex:1">
          <div class="item-title">${d.category||'-'}</div>
          <div class="item-sub">${d.note||''}</div>
        </div>
        <div style="font-weight:900">${fmt(d.amount)}</div>
        <button class="danger">حذف</button>`;
      el.querySelector('button').onclick = del;
      return el;
    }

    function updateNet(){
      const rev = Number(($('#revTotal').textContent||'0').replace(/,/g,''))||0;
      const exp = Number(($('#expTotal').textContent||'0').replace(/,/g,''))||0;
      $('#netTotal').textContent = fmt(rev - exp);
    }

    function loadExpenses(){
      const L=$('#expensesList'); L.innerHTML='';
      col.expenses.orderBy('date','desc').onSnapshot(ss=>{
        L.innerHTML=''; let sum=0;
        ss.forEach(doc=>{
          const d=doc.data(); sum += Number(d.amount)||0;
          L.appendChild(financeRow(d, ()=>col.expenses.doc(doc.id).delete()));
        });
        $('#expTotal').textContent = fmt(sum);
        $('#kpiExp').textContent  = fmt(sum);
        updateNet();
      });
    }
    function loadRevenues(){
      const L=$('#revenuesList'); L.innerHTML='';
      col.revenues.orderBy('date','desc').onSnapshot(ss=>{
        L.innerHTML=''; let sum=0;
        ss.forEach(doc=>{
          const d=doc.data(); sum += Number(d.amount)||0;
          L.appendChild(financeRow(d, ()=>col.revenues.doc(doc.id).delete()));
        });
        $('#revTotal').textContent = fmt(sum);
        $('#kpiRev').textContent  = fmt(sum);
        updateNet();
      });
    }

    // Init
    function initApp(){
      loadTasks(); loadPrices(); loadOrders();
      loadExpenses(); loadRevenues();
    }
  </script>
</body>
</html>
